
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Scientific Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .calc-button {
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }
        .calc-button:active {
            transform: scale(0.92);
            filter: brightness(1.4);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .mask-fade-top {
            mask-image: linear-gradient(to bottom, transparent, black 40%);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 40%);
        }

        #root {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM from ESM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
      }
    }
    </script>

    <script type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // --- MATH ENGINE LOGIC ---
        class MathEngine {
            static factorial(n) {
                if (n < 0 || !Number.isInteger(n)) return NaN;
                if (n === 0) return 1;
                let res = 1;
                for (let i = 2; i <= n; i++) res *= i;
                return res;
            }

            static evaluate(expression, mode) {
                const sanitized = expression
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/π/g, Math.PI.toString())
                    .replace(/e/g, Math.E.toString());

                const tokens = this.tokenize(sanitized);
                return this.parseAndEval(tokens, mode);
            }

            static tokenize(expr) {
                const regex = /\d*\.\d+|\d+|[+\-*/^()!]|sin|cos|tan|log|ln|sqrt/g;
                return expr.match(regex) || [];
            }

            static parseAndEval(tokens, mode) {
                let pos = 0;
                const peek = () => tokens[pos];
                const consume = () => tokens[pos++];

                const parsePrimary = () => {
                    let token = consume();
                    if (!token) return 0;
                    if (token === '(') {
                        const val = parseExpression();
                        consume(); 
                        return val;
                    }
                    if (token === '-') return -parsePrimary();
                    if (/^\d*\.\d+|\d+$/.test(token)) return parseFloat(token);

                    if (['sin', 'cos', 'tan', 'sqrt', 'log', 'ln'].includes(token)) {
                        const next = parsePrimary();
                        let res;
                        switch (token) {
                            case 'sin': 
                                res = mode === 'DEG' ? Math.sin(next * Math.PI / 180) : Math.sin(next);
                                return Math.abs(res) < 1e-15 ? 0 : res;
                            case 'cos': 
                                res = mode === 'DEG' ? Math.cos(next * Math.PI / 180) : Math.cos(next);
                                return Math.abs(res) < 1e-15 ? 0 : res;
                            case 'tan': 
                                const rad = mode === 'DEG' ? (next * Math.PI / 180) : next;
                                if (Math.abs(Math.cos(rad)) < 1e-15) throw new Error("Undefined");
                                res = Math.tan(rad);
                                return Math.abs(res) < 1e-15 ? 0 : res;
                            case 'sqrt': return Math.sqrt(next);
                            case 'log': return Math.log10(next);
                            case 'ln': return Math.log(next);
                            default: return 0;
                        }
                    }
                    return 0;
                };

                const parseFactorial = () => {
                    let val = parsePrimary();
                    while (peek() === '!') {
                        consume();
                        val = this.factorial(val);
                    }
                    return val;
                };

                const parseExponent = () => {
                    let val = parseFactorial();
                    while (peek() === '^') {
                        consume();
                        val = Math.pow(val, parseExponent());
                    }
                    return val;
                };

                const parseMulDiv = () => {
                    let val = parseExponent();
                    while (peek() === '*' || peek() === '/') {
                        const op = consume();
                        const next = parseExponent();
                        if (op === '*') val *= next;
                        if (op === '/') {
                            if (next === 0) throw new Error("Div by 0");
                            val /= next;
                        }
                    }
                    return val;
                };

                const parseExpression = () => {
                    let val = parseMulDiv();
                    while (peek() === '+' || peek() === '-') {
                        const op = consume();
                        const next = parseMulDiv();
                        if (op === '+') val += next;
                        if (op === '-') val -= next;
                    }
                    return val;
                };

                const result = parseExpression();
                if (isNaN(result)) throw new Error("Invalid Input");
                return result;
            }

            static formatResult(val) {
                if (isNaN(val)) return 'Error';
                if (!isFinite(val)) return 'Infinity';
                if (Math.abs(val) > 1e12 || (Math.abs(val) < 1e-9 && val !== 0)) {
                    return val.toExponential(6);
                }
                return Number(val.toPrecision(12)).toString();
            }
        }

        // --- COMPONENTS ---
        const Display = ({ expression, result, error, mode, history }) => {
            const scrollRef = useRef(null);
            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
                }
            }, [history]);

            return (
                <div className="bg-black p-8 md:p-12 flex flex-col items-end justify-end flex-grow min-h-0 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-blue-600/5 rounded-full -mr-64 -mt-64 blur-[140px] pointer-events-none"></div>
                    <div className="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-900/10 rounded-full -ml-48 -mb-48 blur-[120px] pointer-events-none"></div>
                    
                    <div className="w-full flex justify-between items-center mb-6 z-10 shrink-0">
                        <div className="flex gap-2">
                            <span className={`px-4 py-1.5 rounded-full text-[10px] font-black tracking-[0.2em] transition-all border ${mode === 'DEG' ? 'bg-white border-white text-black' : 'border-zinc-800 text-zinc-600'}`}>DEG</span>
                            <span className={`px-4 py-1.5 rounded-full text-[10px] font-black tracking-[0.2em] transition-all border ${mode === 'RAD' ? 'bg-white border-white text-black' : 'border-zinc-800 text-zinc-600'}`}>RAD</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${error ? 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.8)]' : 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.8)]'}`}></div>
                            <span className="text-[10px] font-bold text-zinc-600 tracking-[0.2em] uppercase">{error ? 'Fault' : 'System Ready'}</span>
                        </div>
                    </div>
                    
                    <div ref={scrollRef} className="w-full flex flex-col items-end opacity-20 mb-4 overflow-y-auto flex-grow flex-shrink basis-0 scroll-smooth hide-scrollbar mask-fade-top">
                        {history.map((item, idx) => (
                            <div key={idx} className="text-sm font-medium text-zinc-400 mono py-1 whitespace-nowrap">{item}</div>
                        ))}
                    </div>

                    <div className="w-full overflow-x-auto hide-scrollbar text-right z-10 mb-2 shrink-0">
                        <div className="text-zinc-500 text-2xl font-light tracking-tight mono whitespace-nowrap min-h-[2rem]">{expression || ' '}</div>
                    </div>
                    
                    <div className="w-full overflow-x-auto hide-scrollbar text-right z-10 shrink-0">
                        <div className={`text-5xl md:text-7xl font-semibold tracking-tighter mono transition-all duration-300 ${error ? 'text-red-600' : 'text-white'}`}>
                            {error ? 'ERR' : (result || '0')}
                        </div>
                    </div>
                </div>
            );
        };

        const Pad = ({ onInput }) => {
            const buttons = [
                { label: 'AC', value: 'AC', type: 'action' },
                { label: 'DEL', value: 'DEL', type: 'action' },
                { label: '(', value: '(', type: 'num' },
                { label: ')', value: ')', type: 'num' },
                { label: '÷', value: '÷', type: 'op' },
                { label: 'sin', value: 'sin(', type: 'func' },
                { label: '7', value: '7', type: 'num' },
                { label: '8', value: '8', type: 'num' },
                { label: '9', value: '9', type: 'num' },
                { label: '×', value: '×', type: 'op' },
                { label: 'cos', value: 'cos(', type: 'func' },
                { label: '4', value: '4', type: 'num' },
                { label: '5', value: '5', type: 'num' },
                { label: '6', value: '6', type: 'num' },
                { label: '-', value: '-', type: 'op' },
                { label: 'tan', value: 'tan(', type: 'func' },
                { label: '1', value: '1', type: 'num' },
                { label: '2', value: '2', type: 'num' },
                { label: '3', value: '3', type: 'num' },
                { label: '+', value: '+', type: 'op' },
                { label: 'log', value: 'log(', type: 'func' },
                { label: '0', value: '0', type: 'num' },
                { label: '.', value: '.', type: 'num' },
                { label: '!', value: '!', type: 'op' },
                { label: '=', value: '=', type: 'action' },
                { label: '√', value: 'sqrt(', type: 'func' },
                { label: 'xʸ', value: '^', type: 'op' },
                { label: 'π', value: 'π', type: 'const' },
                { label: 'e', value: 'e', type: 'const' },
                { label: 'DR', value: 'MODE', type: 'action' },
            ];

            return (
                <div className="grid grid-cols-5 gap-2 p-6 bg-black border-t border-zinc-900">
                    {buttons.map((btn, i) => (
                        <button
                            key={i}
                            onClick={() => onInput(btn.value, btn.type)}
                            className={`
                                calc-button h-16 rounded-xl flex items-center justify-center text-sm font-bold tracking-wide transition-all
                                ${btn.type === 'num' ? 'bg-zinc-900 text-white hover:bg-zinc-800' : ''}
                                ${['op', 'func', 'const'].includes(btn.type) ? 'bg-zinc-950 text-blue-500 hover:text-blue-400' : ''}
                                ${btn.type === 'action' ? 'bg-zinc-800 text-zinc-300 hover:bg-zinc-700' : ''}
                                ${btn.value === '=' ? 'bg-blue-600 !text-white hover:bg-blue-500 shadow-[0_0_20px_rgba(37,99,235,0.4)] border-none' : ''}
                                ${btn.value === 'AC' ? '!text-orange-500' : ''}
                            `}
                        >
                            <span className={btn.value === '=' ? 'text-4xl leading-none' : ''}>{btn.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [state, setState] = useState({
                expression: '',
                result: null,
                mode: 'DEG',
                error: null,
                history: []
            });

            const handleCalculate = useCallback(() => {
                if (!state.expression) return;
                try {
                    const num = MathEngine.evaluate(state.expression, state.mode);
                    const formatted = MathEngine.formatResult(num);
                    setState(prev => ({
                        ...prev,
                        result: formatted,
                        error: null,
                        history: [...prev.history, `${prev.expression} = ${formatted}`].slice(-20)
                    }));
                } catch (err) {
                    setState(prev => ({ ...prev, error: err.message, result: null }));
                }
            }, [state.expression, state.mode]);

            const handleInput = useCallback((val, type) => {
                setState(prev => {
                    if (val === 'AC') return { ...prev, expression: '', result: null, error: null };
                    if (val === 'DEL') {
                        if (prev.error || prev.result) return { ...prev, expression: '', result: null, error: null };
                        return { ...prev, expression: prev.expression.slice(0, -1), error: null };
                    }
                    if (val === 'MODE') return { ...prev, mode: prev.mode === 'DEG' ? 'RAD' : 'DEG' };
                    if (val === '=') {
                        // Triggers useEffect or manual call
                        setTimeout(handleCalculate, 0);
                        return prev;
                    }

                    let nextExpr = prev.expression;
                    if (prev.result) {
                        nextExpr = type === 'op' ? prev.result + val : val;
                        return { ...prev, expression: nextExpr, result: null, error: null };
                    }
                    if (prev.error) return { ...prev, expression: val, error: null, result: null };
                    
                    return { ...prev, expression: nextExpr + val };
                });
            }, [handleCalculate]);

            return (
                <div className="flex flex-col w-full h-screen bg-black select-none font-sans overflow-hidden">
                    <div className="flex-1 flex flex-col max-w-5xl mx-auto w-full min-h-0">
                        <Display {...state} />
                        <div className="shrink-0"><Pad onInput={handleInput} /></div>
                        <div className="pb-4 pt-2 shrink-0 text-center text-[10px] text-zinc-800 font-bold uppercase tracking-[0.5em]">
                            Scientific Logic System v2.0
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
